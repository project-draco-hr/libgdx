{
  if (httpRequest.getUrl() == null) {
    httpResponseListener.failed(new GdxRuntimeException("can't process a HTTP request without URL set"));
    return;
  }
  try {
    final String method=httpRequest.getMethod();
    URL url;
    if (method.equalsIgnoreCase(HttpMethods.GET)) {
      String queryString="";
      String value=httpRequest.getContent();
      if (value != null && !"".equals(value))       queryString="?" + value;
      url=new URL(httpRequest.getUrl() + queryString);
    }
 else {
      url=new URL(httpRequest.getUrl());
    }
    final HttpURLConnection connection=(HttpURLConnection)url.openConnection();
    final boolean doingOutPut=method.equalsIgnoreCase(HttpMethods.POST) || method.equalsIgnoreCase(HttpMethods.PUT);
    connection.setDoOutput(doingOutPut);
    connection.setDoInput(true);
    connection.setRequestMethod(method);
    HttpURLConnection.setFollowRedirects(httpRequest.getFollowRedirects());
    lock.lock();
    connections.put(httpRequest,connection);
    listeners.put(httpRequest,httpResponseListener);
    lock.unlock();
    for (    Map.Entry<String,String> header : httpRequest.getHeaders().entrySet())     connection.addRequestProperty(header.getKey(),header.getValue());
    connection.setConnectTimeout(httpRequest.getTimeOut());
    connection.setReadTimeout(httpRequest.getTimeOut());
    executorService.submit(new Runnable(){
      @Override public void run(){
        try {
          if (doingOutPut) {
            String contentAsString=httpRequest.getContent();
            if (contentAsString != null) {
              OutputStreamWriter writer=new OutputStreamWriter(connection.getOutputStream());
              try {
                writer.write(contentAsString);
              }
  finally {
                StreamUtils.closeQuietly(writer);
              }
            }
 else {
              InputStream contentAsStream=httpRequest.getContentStream();
              if (contentAsStream != null) {
                OutputStream os=connection.getOutputStream();
                try {
                  StreamUtils.copyStream(contentAsStream,os);
                }
  finally {
                  StreamUtils.closeQuietly(os);
                }
              }
            }
          }
          connection.connect();
          final HttpClientResponse clientResponse=new HttpClientResponse(connection);
          try {
            lock.lock();
            HttpResponseListener listener=listeners.get(httpRequest);
            if (listener != null) {
              lock.unlock();
              listener.handleHttpResponse(clientResponse);
              lock.lock();
              listeners.remove(httpRequest);
            }
            connections.remove(httpRequest);
          }
  finally {
            lock.unlock();
            connection.disconnect();
          }
        }
 catch (        final Exception e) {
          connection.disconnect();
          try {
            httpResponseListener.failed(e);
          }
  finally {
            lock.lock();
            connections.remove(httpRequest);
            listeners.remove(httpRequest);
            lock.unlock();
          }
        }
      }
    }
);
  }
 catch (  Exception e) {
    try {
      httpResponseListener.failed(e);
    }
  finally {
      lock.lock();
      connections.remove(httpRequest);
      listeners.remove(httpRequest);
      lock.unlock();
    }
    return;
  }
}

{
  try {
    MessageDigest digest=MessageDigest.getInstance("SHA1");
    int width=image.getWidth();
    int height=image.getHeight();
    if (image.getType() != BufferedImage.TYPE_INT_ARGB) {
      BufferedImage newImage=new BufferedImage(width,height,BufferedImage.TYPE_INT_ARGB);
      newImage.getGraphics().drawImage(image,0,0,null);
      image=newImage;
    }
    WritableRaster raster=image.getRaster();
    int[] pixels=new int[width];
    for (int y=0; y < height; y++) {
      raster.getDataElements(0,y,width,1,pixels);
      for (int x=0; x < width; x++) {
        int rgba=pixels[x];
        digest.update((byte)(rgba >> 24));
        digest.update((byte)(rgba >> 16));
        digest.update((byte)(rgba >> 8));
        digest.update((byte)rgba);
      }
    }
    digest.update((byte)(width >> 24));
    digest.update((byte)(width >> 16));
    digest.update((byte)(width >> 8));
    digest.update((byte)width);
    digest.update((byte)(height >> 24));
    digest.update((byte)(height >> 16));
    digest.update((byte)(height >> 8));
    digest.update((byte)height);
    return new BigInteger(1,digest.digest()).toString(16);
  }
 catch (  NoSuchAlgorithmException ex) {
    throw new RuntimeException(ex);
  }
}

{
  boolean keepRunning=true;
  int port=8988;
  ServerSocketChannel serverChannel=ServerSocketChannel.open();
  try {
    serverChannel.configureBlocking(false);
    serverChannel.socket().bind(new InetSocketAddress("0.0.0.0",port));
    Selector selector=Selector.open();
    serverChannel.register(selector,SelectionKey.OP_ACCEPT,null);
    while (keepRunning) {
      System.out.println("Running main loop");
      selector.select(10000);
      for (      SelectionKey key : selector.selectedKeys()) {
        if (key.isAcceptable()) {
          System.out.println("Accepting new connection");
          SocketChannel c=((ServerSocketChannel)key.channel()).accept();
          if (c != null) {
            c.configureBlocking(false);
            c.register(selector,SelectionKey.OP_READ,new Connection());
          }
        }
 else {
          SocketChannel c=(SocketChannel)key.channel();
          if (c.isOpen() && key.isReadable()) {
            Connection connection=(Connection)key.attachment();
            connection.handleRead(c);
          }
        }
      }
      selector.selectedKeys().clear();
    }
  }
  finally {
    serverChannel.close();
  }
}

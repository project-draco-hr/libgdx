{
  BufferedReader reader=new BufferedReader(new InputStreamReader(in));
  List<String> tokens=new ArrayList<String>();
  MD5Animation animation=new MD5Animation();
  try {
    String line;
    JointInfo[] jointInfos=null;
    BaseFrameJoint[] baseFrame=null;
    float[] animFrameData=null;
    while ((line=reader.readLine()) != null) {
      MD5Tokenizer.tokenize(line,tokens);
      if (tokens.size() == 0)       continue;
      if (tokens.get(0).equals("MD5Version")) {
        if (!tokens.get(1).equals("10"))         throw new IllegalArgumentException("Not a valid MD5 animation file, version is " + tokens.get(1) + ", expected 10");
      }
      if (tokens.get(0).equals("numFrames")) {
        int numFrames=parseInt(tokens.get(1));
        animation.frames=new MD5Joints[numFrames];
        animation.bounds=new BoundingBox[numFrames];
      }
      if (tokens.get(0).equals("numJoints")) {
        int numJoints=parseInt(tokens.get(1));
        for (int i=0; i < animation.frames.length; i++) {
          animation.frames[i]=new MD5Joints();
          animation.frames[i].numJoints=numJoints;
          animation.frames[i].names=new String[numJoints];
          animation.frames[i].joints=new float[numJoints * 8];
        }
        jointInfos=new JointInfo[numJoints];
        baseFrame=new BaseFrameJoint[numJoints];
      }
      if (tokens.get(0).equals("frameRate")) {
        int frameRate=parseInt(tokens.get(1));
        animation.frameRate=frameRate;
        animation.secondsPerFrame=1.0f / frameRate;
      }
      if (tokens.get(0).equals("numAnimatedComponents")) {
        int numAnimatedComponents=parseInt(tokens.get(1));
        animFrameData=new float[numAnimatedComponents];
      }
      if (tokens.get(0).equals("hierarchy")) {
        for (int i=0; i < jointInfos.length; i++) {
          line=reader.readLine();
          MD5Tokenizer.tokenize(line,tokens);
          if (tokens.size() == 0 || tokens.get(0).equals("//")) {
            i--;
            continue;
          }
          JointInfo jointInfo=new JointInfo();
          jointInfo.name=tokens.get(0);
          jointInfo.parent=parseInt(tokens.get(1));
          jointInfo.flags=parseInt(tokens.get(2));
          jointInfo.startIndex=parseInt(tokens.get(3));
          jointInfos[i]=jointInfo;
        }
      }
      if (tokens.get(0).equals("bounds")) {
        for (int i=0; i < animation.bounds.length; i++) {
          line=reader.readLine();
          MD5Tokenizer.tokenize(line,tokens);
          if (tokens.size() == 0) {
            i--;
            continue;
          }
          BoundingBox bounds=new BoundingBox();
          bounds.min.x=parseFloat(tokens.get(1));
          bounds.min.y=parseFloat(tokens.get(2));
          bounds.min.z=parseFloat(tokens.get(3));
          bounds.max.x=parseFloat(tokens.get(6));
          bounds.max.y=parseFloat(tokens.get(7));
          bounds.max.z=parseFloat(tokens.get(8));
          animation.bounds[i]=bounds;
        }
      }
      if (tokens.get(0).equals("baseframe")) {
        for (int i=0; i < baseFrame.length; i++) {
          line=reader.readLine();
          MD5Tokenizer.tokenize(line,tokens);
          if (tokens.size() == 0) {
            i--;
            continue;
          }
          BaseFrameJoint joint=new BaseFrameJoint();
          joint.pos.x=parseFloat(tokens.get(1));
          joint.pos.y=parseFloat(tokens.get(2));
          joint.pos.z=parseFloat(tokens.get(3));
          joint.orient.x=parseFloat(tokens.get(6));
          joint.orient.y=parseFloat(tokens.get(7));
          joint.orient.z=parseFloat(tokens.get(8));
          joint.orient.computeW();
          baseFrame[i]=joint;
        }
      }
      if (tokens.get(0).equals("frame")) {
        int frameIndex=parseInt(tokens.get(1));
        int i=0;
        line=reader.readLine();
        MD5Tokenizer.tokenize(line,tokens);
        while (tokens.get(0).equals("}") == false) {
          for (int j=0; j < tokens.size(); j++)           animFrameData[i++]=parseFloat(tokens.get(j));
          line=reader.readLine();
          MD5Tokenizer.tokenize(line,tokens);
        }
        buildFrameSkeleton(jointInfos,baseFrame,animFrameData,animation,frameIndex);
      }
    }
    return animation;
  }
 catch (  Exception ex) {
    ex.printStackTrace();
    return null;
  }
}

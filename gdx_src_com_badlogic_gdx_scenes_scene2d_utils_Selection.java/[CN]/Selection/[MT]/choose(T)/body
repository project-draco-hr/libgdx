{
  if (isDisabled)   return;
  snapshot();
  if ((toggle || isCtrlPressed()) && selected.contains(item)) {
    if (required && selected.size == 1)     return;
    if ((required || selected.size > 1) && !isCtrlPressed())     return;
    selected.remove(item);
    lastSelected=null;
  }
 else {
    boolean modified=false;
    if (!toggle && (!multiple || !isCtrlPressed())) {
      modified=selected.size > 0;
      selected.clear();
    }
    if (!selected.add(item) && !modified)     return;
    lastSelected=item;
  }
  if (fireChangeEvent())   revert();
  cleanup();
}

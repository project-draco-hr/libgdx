{
  if (debug && canvas != null) {
    Graphics g=canvas.getGraphics();
    g.setColor(Color.green);
    g.drawRect(0,0,width - 1,height - 1);
  }
  if (direction != Direction.x && direction != Direction.xy)   width+=xPadding;
  if (direction != Direction.y && direction != Direction.xy)   height+=yPadding;
  Node root=new Node(0,0,width,height);
  int usedPixels=0;
  for (int i=images.size() - 1; i >= 0; i--) {
    Image image=images.get(i);
    Node node=root.insert(image,canvas,false);
    if (node == null) {
      if (rotate)       node=root.insert(image,canvas,true);
      if (node == null)       continue;
    }
    usedPixels+=image.getWidth() * image.getHeight();
    images.remove(i);
    if (canvas != null) {
      System.out.println("Packing... " + image.file.getName());
      Graphics2D g=(Graphics2D)canvas.getGraphics();
      if (image.rotate) {
        g.translate(node.left,node.top);
        g.rotate(-90 * MathUtils.degreesToRadians);
        g.translate(-node.left,-node.top);
        g.translate(-image.getWidth(),0);
      }
      g.drawImage(image,node.left,node.top,null);
      if (image.rotate) {
        g.translate(image.getWidth(),0);
        g.translate(node.left,node.top);
        g.rotate(90 * MathUtils.degreesToRadians);
        g.translate(-node.left,-node.top);
      }
      if (debug) {
        g.setColor(Color.magenta);
        int imageWidth=image.getWidth();
        int imageHeight=image.getHeight();
        if (image.rotate)         g.drawRect(node.left,node.top,imageHeight - 1,imageWidth - 1);
 else         g.drawRect(node.left,node.top,imageWidth - 1,imageHeight - 1);
      }
    }
  }
  return images.isEmpty() ? -1 : usedPixels;
}

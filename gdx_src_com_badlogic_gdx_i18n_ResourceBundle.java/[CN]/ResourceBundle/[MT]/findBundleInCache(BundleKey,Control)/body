{
  BundleReference bundleReference=cache.get(bundleKey);
  if (bundleReference == null) {
    return null;
  }
  ResourceBundle bundle=bundleReference.get();
  if (bundle == null) {
    return null;
  }
  if (bundle.parent != null && bundle.parent.expired) {
    bundle.expired=true;
    bundle.bundleKey=null;
    cache.remove(bundleKey,bundleReference);
    return null;
  }
  BundleKey key=bundleReference.getBundleKey();
  long expirationTime=key.expirationTime;
  if (!bundle.expired && expirationTime >= 0 && expirationTime <= TimeUtils.millis()) {
    if (bundle == MISSING_BUNDLE) {
      cache.remove(bundleKey,bundleReference);
      return null;
    }
synchronized (bundle) {
      expirationTime=key.expirationTime;
      if (!bundle.expired && expirationTime >= 0 && expirationTime <= TimeUtils.millis()) {
        try {
          bundle.expired=control.needsReload(key.getName(),key.getLocale(),key.getFormat(),bundle,key.loadTime);
        }
 catch (        Exception e) {
          bundleKey.setThrowable(e);
        }
        if (bundle.expired) {
          bundle.bundleKey=null;
          cache.remove(bundleKey,bundleReference);
        }
 else {
          setExpirationTime(key,control);
        }
      }
    }
  }
  return bundle;
}

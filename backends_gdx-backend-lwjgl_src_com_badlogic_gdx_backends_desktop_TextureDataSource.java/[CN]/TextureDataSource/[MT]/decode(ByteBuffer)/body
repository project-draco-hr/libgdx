{
  int imgWidth=img.getWidth();
  int imgHeight=img.getHeight();
  ByteBuffer bb=buffer.slice();
  bb.order(ByteOrder.LITTLE_ENDIAN);
  IntBuffer ib=bb.asIntBuffer();
  Raster r=img.getRaster();
  if (img.getType() == BufferedImage.TYPE_INT_ARGB) {
    ib.put(((DataBufferInt)r.getDataBuffer()).getData(),0,imgWidth * imgHeight);
  }
 else {
    ColorModel cm=img.getColorModel();
    Object data=r.getDataElements(0,0,null);
    for (int y=0; y < imgHeight; y++) {
      for (int x=0; x < imgWidth; x++) {
        int color=cm.getRGB(r.getDataElements(x,y,data));
        ib.put(color);
      }
    }
  }
  buffer.position(buffer.position() + ib.position() * 4);
}

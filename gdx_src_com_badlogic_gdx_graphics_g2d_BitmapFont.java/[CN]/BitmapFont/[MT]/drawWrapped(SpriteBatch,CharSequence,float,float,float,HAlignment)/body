{
  float batchColor=spriteBatch.color;
  float down=this.data.down;
  int start=0;
  int numLines=0;
  int length=str.length();
  float maxWidth=0;
  while (start < length) {
    int lineEnd=start + computeVisibleGlyphs(str,start,indexOf(str,'\n',start),wrapWidth);
    int nextLineStart;
    if (lineEnd < length) {
      int originalLineEnd=lineEnd;
      while (lineEnd > start) {
        char ch=str.charAt(lineEnd);
        if (ch == ' ' || ch == '\n')         break;
        lineEnd--;
      }
      if (lineEnd == start) {
        lineEnd=originalLineEnd;
        if (lineEnd == start)         lineEnd++;
        nextLineStart=lineEnd;
      }
 else       nextLineStart=lineEnd + 1;
    }
 else {
      if (lineEnd == start)       lineEnd++;
      nextLineStart=length;
    }
    float xOffset=0;
    if (alignment != HAlignment.LEFT) {
      float lineWidth=getBounds(str,start,lineEnd).width;
      xOffset=wrapWidth - lineWidth;
      if (alignment == HAlignment.CENTER)       xOffset/=2;
    }
    float lineWidth=draw(spriteBatch,str,x + xOffset,y,start,lineEnd).width;
    maxWidth=Math.max(maxWidth,lineWidth);
    start=nextLineStart;
    y+=down;
    numLines++;
  }
  spriteBatch.setColor(batchColor);
  textBounds.width=maxWidth;
  textBounds.height=data.capHeight + (numLines - 1) * data.lineHeight;
  return textBounds;
}

{
  if (cells.size() > 0 && !cells.get(cells.size() - 1).endRow)   endRow();
  int[] columnMinWidth=new int[columns];
  int[] rowMinHeight=new int[rows];
  int[] columnPrefWidth=new int[columns];
  int[] rowPrefHeight=new int[rows];
  int spaceRightLast=0;
  for (int i=0, n=cells.size(); i < n; i++) {
    Cell c=cells.get(i);
    if (c.ignore)     continue;
    c.padLeftTemp=c.column == 0 ? width(c.padLeft) : width(c.padLeft) + Math.max(0,width(c.spaceLeft) - spaceRightLast);
    c.padTopTemp=c.cellAboveIndex == -1 ? height(c.padTop) : height(c.padTop) + Math.max(0,height(c.spaceTop) - height(cells.get(c.cellAboveIndex).spaceBottom));
    int spaceRight=width(c.spaceRight);
    c.padRightTemp=c.column + c.colspan == columns ? width(c.padRight) : width(c.padRight) + spaceRight;
    c.padBottomTemp=c.row == rows - 1 ? height(c.padBottom) : height(c.padBottom) + height(c.spaceBottom);
    spaceRightLast=spaceRight;
    int prefWidth=getWidth((T)c.widget,c.prefWidth);
    int prefHeight=getHeight((T)c.widget,c.prefHeight);
    int minWidth=getWidth((T)c.widget,c.minWidth);
    int minHeight=getHeight((T)c.widget,c.minHeight);
    if (prefWidth < minWidth)     prefWidth=minWidth;
    if (prefHeight < minHeight)     prefHeight=minHeight;
    if (c.colspan == 1) {
      int hpadding=c.padLeftTemp + c.padRightTemp;
      columnPrefWidth[c.column]=Math.max(columnPrefWidth[c.column],prefWidth + hpadding);
      columnMinWidth[c.column]=Math.max(columnMinWidth[c.column],minWidth + hpadding);
    }
    int vpadding=c.padTopTemp + c.padBottomTemp;
    rowPrefHeight[c.row]=Math.max(rowPrefHeight[c.row],prefHeight + vpadding);
    rowMinHeight[c.row]=Math.max(rowMinHeight[c.row],minHeight + vpadding);
  }
  tableMinWidth=0;
  tableMinHeight=0;
  tablePrefWidth=0;
  tablePrefHeight=0;
  for (int i=0; i < columns; i++) {
    tableMinWidth+=columnMinWidth[i];
    tablePrefWidth+=columnPrefWidth[i];
  }
  for (int i=0; i < rows; i++) {
    tableMinHeight+=rowMinHeight[i];
    tablePrefHeight+=Math.max(rowMinHeight[i],rowPrefHeight[i]);
  }
  int hpadding=width(padLeft) + width(padRight);
  int vpadding=height(padTop) + height(padBottom);
  int width=width(this.width) - hpadding;
  int height=height(this.height) - vpadding;
  tableMinWidth=Math.max(tableMinWidth + hpadding,width);
  tableMinHeight=Math.max(tableMinHeight + vpadding,height);
  tablePrefWidth=Math.max(tablePrefWidth + hpadding,tableMinWidth);
  tablePrefHeight=Math.max(tablePrefHeight + vpadding,tableMinHeight);
  int[] columnMaxWidth;
  int tableLayoutWidth=this.tableLayoutWidth;
  int totalGrowWidth=tablePrefWidth - tableMinWidth;
  if (totalGrowWidth == 0)   columnMaxWidth=columnMinWidth;
 else {
    int extraWidth=Math.max(0,tableLayoutWidth - tableMinWidth);
    columnMaxWidth=new int[columns];
    for (int i=0; i < columns; i++) {
      int growWidth=columnPrefWidth[i] - columnMinWidth[i];
      float growRatio=growWidth / (float)totalGrowWidth;
      columnMaxWidth[i]=columnMinWidth[i] + (int)(extraWidth * growRatio);
    }
  }
  int[] rowMaxHeight;
  int tableLayoutHeight=this.tableLayoutHeight;
  int totalGrowHeight=tablePrefHeight - tableMinHeight;
  if (totalGrowHeight == 0)   rowMaxHeight=rowMinHeight;
 else {
    int extraHeight=Math.max(0,tableLayoutHeight - tableMinHeight);
    rowMaxHeight=new int[rows];
    for (int i=0; i < rows; i++) {
      int growHeight=rowPrefHeight[i] - rowMinHeight[i];
      float growRatio=growHeight / (float)totalGrowHeight;
      rowMaxHeight[i]=rowMinHeight[i] + (int)(extraHeight * growRatio);
    }
  }
  int[] columnWidth=new int[columns];
  int[] rowHeight=new int[rows];
  float[] expandWidth=new float[columns];
  float[] expandHeight=new float[rows];
  float totalExpandWidth=0, totalExpandHeight=0;
  for (int i=0, n=cells.size(); i < n; i++) {
    Cell c=cells.get(i);
    if (c.ignore)     continue;
    int spannedCellMaxWidth=0;
    for (int column=c.column, nn=column + c.colspan; column < nn; column++) {
      spannedCellMaxWidth+=columnMaxWidth[column];
      if (c.colspan == 1 && c.expandWidth != 0 && expandWidth[column] == 0) {
        expandWidth[column]=c.expandWidth / (float)c.colspan;
        totalExpandWidth+=c.expandWidth / (float)c.colspan;
      }
    }
    spannedCellMaxWidth-=c.padLeftTemp + c.padRightTemp;
    if (c.expandHeight != 0 && expandHeight[c.row] == 0) {
      expandHeight[c.row]=c.expandHeight;
      totalExpandHeight+=c.expandHeight;
    }
    int prefWidth=getWidth((T)c.widget,c.prefWidth);
    int prefHeight=getHeight((T)c.widget,c.prefHeight);
    int minWidth=getWidth((T)c.widget,c.minWidth);
    int minHeight=getHeight((T)c.widget,c.minHeight);
    if (prefWidth < minWidth)     prefWidth=minWidth;
    if (prefHeight < minHeight)     prefHeight=minHeight;
    c.widgetWidth=Math.min(spannedCellMaxWidth,prefWidth);
    c.widgetHeight=Math.min(rowMaxHeight[c.row] - c.padTopTemp - c.padBottomTemp,prefHeight);
    if (c.colspan == 1)     columnWidth[c.column]=Math.max(columnWidth[c.column],c.widgetWidth + c.padLeftTemp + c.padRightTemp);
    rowHeight[c.row]=Math.max(rowHeight[c.row],c.widgetHeight + c.padTopTemp + c.padBottomTemp);
  }
  int uniformMaxWidth=0, uniformMaxHeight=0;
  for (int i=0, n=cells.size(); i < n; i++) {
    Cell c=cells.get(i);
    if (c.ignore)     continue;
    if (c.uniformWidth != null)     uniformMaxWidth=Math.max(uniformMaxWidth,columnWidth[c.column]);
    if (c.uniformHeight != null)     uniformMaxHeight=Math.max(uniformMaxHeight,rowHeight[c.row]);
  }
  if (uniformMaxWidth > 0 || uniformMaxHeight > 0) {
    outer:     for (int i=0, n=cells.size(); i < n; i++) {
      Cell c=cells.get(i);
      if (c.ignore)       continue;
      if (uniformMaxWidth > 0 && c.uniformWidth != null) {
        int diff=uniformMaxWidth - columnWidth[c.column];
        if (diff > 0) {
          columnWidth[c.column]=uniformMaxWidth;
          tableMinWidth+=diff;
          tablePrefWidth+=diff;
        }
      }
      if (uniformMaxHeight > 0 && c.uniformHeight != null) {
        int diff=uniformMaxHeight - rowHeight[c.row];
        if (diff > 0) {
          rowHeight[c.row]=uniformMaxHeight;
          tableMinHeight+=diff;
          tablePrefHeight+=diff;
        }
      }
      continue outer;
    }
  }
  if (totalExpandWidth > 0) {
    int extra=Math.max(0,tableLayoutWidth - tablePrefWidth);
    int used=0, lastIndex=0;
    for (int i=0; i < columns; i++) {
      if (expandWidth[i] == 0)       continue;
      int amount=(int)(extra * expandWidth[i] / totalExpandWidth);
      columnWidth[i]+=amount;
      used+=amount;
      lastIndex=i;
    }
    columnWidth[lastIndex]+=extra - used;
  }
  if (totalExpandHeight > 0) {
    int extra=Math.max(0,tableLayoutHeight - tablePrefHeight);
    int used=0, lastIndex=0;
    for (int i=0; i < rows; i++) {
      if (expandHeight[i] == 0)       continue;
      int amount=(int)(extra * expandHeight[i] / totalExpandHeight);
      rowHeight[i]+=amount;
      used+=amount;
      lastIndex=i;
    }
    rowHeight[lastIndex]+=extra - used;
  }
  for (int i=0, n=cells.size(); i < n; i++) {
    Cell c=cells.get(i);
    if (c.ignore)     continue;
    if (c.colspan == 1)     continue;
    int minWidth=getWidth((T)c.widget,c.minWidth);
    int spannedCellWidth=0;
    for (int column=c.column, nn=column + c.colspan; column < nn; column++)     spannedCellWidth+=columnWidth[column];
    int extraWidth=Math.max(0,minWidth - spannedCellWidth) / c.colspan;
    for (int column=c.column, nn=column + c.colspan; column < nn; column++)     columnWidth[column]+=extraWidth;
    c.widgetWidth=Math.max(c.widgetWidth,minWidth - (c.padLeftTemp + c.padRightTemp));
  }
  int tableWidth=0, tableHeight=0;
  for (int i=0; i < columns; i++)   tableWidth+=columnWidth[i];
  tableWidth=Math.max(tableWidth + hpadding,width);
  for (int i=0; i < rows; i++)   tableHeight+=rowHeight[i];
  tableHeight=Math.max(tableHeight + vpadding,height);
  int x=tableLayoutX + width(padLeft);
  if ((align & RIGHT) != 0)   x+=tableLayoutWidth - tableWidth;
 else   if ((align & LEFT) == 0)   x+=(tableLayoutWidth - tableWidth) / 2;
  int y=tableLayoutY + height(padTop);
  if ((align & BOTTOM) != 0)   y+=tableLayoutHeight - tableHeight;
 else   if ((align & TOP) == 0)   y+=(tableLayoutHeight - tableHeight) / 2;
  int currentX=x;
  int currentY=y;
  for (int i=0, n=cells.size(); i < n; i++) {
    Cell c=cells.get(i);
    if (c.ignore)     continue;
    int spannedCellWidth=0;
    for (int column=c.column, nn=column + c.colspan; column < nn; column++)     spannedCellWidth+=columnWidth[column];
    spannedCellWidth-=c.padLeftTemp + c.padRightTemp;
    currentX+=c.padLeftTemp;
    if (c.fillWidth > 0) {
      c.widgetWidth=(int)(spannedCellWidth * c.fillWidth);
      int maxWidth=getWidth((T)c.widget,c.maxWidth);
      if (maxWidth > 0)       c.widgetWidth=Math.min(c.widgetWidth,maxWidth);
    }
    if (c.fillHeight > 0) {
      c.widgetHeight=(int)(rowHeight[c.row] * c.fillHeight) - c.padTopTemp - c.padBottomTemp;
      int maxHeight=getHeight((T)c.widget,c.maxHeight);
      if (maxHeight > 0)       c.widgetHeight=Math.min(c.widgetHeight,maxHeight);
    }
    if ((c.align & LEFT) != 0)     c.widgetX=currentX;
 else     if ((c.align & RIGHT) != 0)     c.widgetX=currentX + spannedCellWidth - c.widgetWidth;
 else     c.widgetX=currentX + (spannedCellWidth - c.widgetWidth) / 2;
    if ((c.align & TOP) != 0)     c.widgetY=currentY + c.padTopTemp;
 else     if ((c.align & BOTTOM) != 0)     c.widgetY=currentY + rowHeight[c.row] - c.widgetHeight - c.padBottomTemp;
 else     c.widgetY=currentY + (rowHeight[c.row] - c.widgetHeight + c.padTopTemp - c.padBottomTemp) / 2;
    if (c.endRow) {
      currentX=x;
      currentY+=rowHeight[c.row];
    }
 else     currentX+=spannedCellWidth + c.padRightTemp;
  }
  if (debug == null)   return;
  clearDebugRectangles();
  currentX=x;
  currentY=y;
  if (debug.contains(DEBUG_TABLE) || debug.contains(DEBUG_ALL)) {
    addDebugRectangle(DEBUG_TABLE,tableLayoutX,tableLayoutY,tableLayoutWidth,tableLayoutHeight);
    addDebugRectangle(DEBUG_TABLE,x,y,tableWidth - hpadding,tableHeight - vpadding);
  }
  for (int i=0, n=cells.size(); i < n; i++) {
    Cell c=cells.get(i);
    if (c.ignore)     continue;
    if (debug.contains(DEBUG_WIDGET) || debug.contains(DEBUG_ALL))     addDebugRectangle(DEBUG_WIDGET,c.widgetX,c.widgetY,c.widgetWidth,c.widgetHeight);
    int spannedCellWidth=0;
    for (int column=c.column, nn=column + c.colspan; column < nn; column++)     spannedCellWidth+=columnWidth[column];
    spannedCellWidth-=c.padLeftTemp + c.padRightTemp;
    currentX+=c.padLeftTemp;
    if (debug.contains(DEBUG_CELL) || debug.contains(DEBUG_ALL))     addDebugRectangle(DEBUG_CELL,currentX,currentY + c.padTopTemp,spannedCellWidth,rowHeight[c.row] - c.padTopTemp - c.padBottomTemp);
    if (c.endRow) {
      currentX=x;
      currentY+=rowHeight[c.row];
    }
 else     currentX+=spannedCellWidth + c.padRightTemp;
  }
}

{
  float startX=x;
  BitmapFont font=this.font;
  Glyph lastGlyph=null;
  BitmapFontData data=font.data;
  textChanged=start < end;
  if (data.scaleX == 1 && data.scaleY == 1) {
    while (start < end) {
      char ch=str.charAt(start++);
      if (ch == '[' && font.markupEnabled) {
        if (start < end && str.charAt(start) == '[')         start++;
 else {
          int colorTagLen=markup.parseColorTag(str,charsCount,start,end);
          if (colorTagLen >= 0) {
            color=markup.getLastColor().toFloatBits();
            start+=colorTagLen + 1;
            continue;
          }
        }
      }
      lastGlyph=data.getGlyph(ch);
      if (lastGlyph != null) {
        addGlyph(lastGlyph,x + lastGlyph.xoffset,y + lastGlyph.yoffset,lastGlyph.width,lastGlyph.height);
        x+=lastGlyph.xadvance;
        break;
      }
    }
    while (start < end) {
      char ch=str.charAt(start++);
      if (ch == '[' && font.markupEnabled) {
        if (start < end && str.charAt(start) == '[')         start++;
 else {
          int colorTagLen=markup.parseColorTag(str,charsCount,start,end);
          if (colorTagLen >= 0) {
            color=markup.getLastColor().toFloatBits();
            start+=colorTagLen + 1;
            continue;
          }
        }
      }
      Glyph g=data.getGlyph(ch);
      if (g != null) {
        x+=lastGlyph.getKerning(ch);
        lastGlyph=g;
        addGlyph(lastGlyph,x + g.xoffset,y + g.yoffset,g.width,g.height);
        x+=g.xadvance;
      }
    }
  }
 else {
    float scaleX=data.scaleX, scaleY=data.scaleY;
    while (start < end) {
      char ch=str.charAt(start++);
      if (ch == '[' && font.markupEnabled) {
        if (start < end && str.charAt(start) == '[')         start++;
 else {
          int colorTagLen=markup.parseColorTag(str,charsCount,start,end);
          if (colorTagLen >= 0) {
            color=markup.getLastColor().toFloatBits();
            start+=colorTagLen + 1;
            continue;
          }
        }
      }
      lastGlyph=data.getGlyph(ch);
      if (lastGlyph != null) {
        addGlyph(lastGlyph,x + lastGlyph.xoffset * scaleX,y + lastGlyph.yoffset * scaleY,lastGlyph.width * scaleX,lastGlyph.height * scaleY);
        x+=lastGlyph.xadvance * scaleX;
        break;
      }
    }
    while (start < end) {
      char ch=str.charAt(start++);
      if (ch == '[' && font.markupEnabled) {
        if (start < end && str.charAt(start) == '[')         start++;
 else {
          int colorTagLen=markup.parseColorTag(str,charsCount,start,end);
          if (colorTagLen >= 0) {
            color=markup.getLastColor().toFloatBits();
            start+=colorTagLen + 1;
            continue;
          }
        }
      }
      Glyph g=data.getGlyph(ch);
      if (g != null) {
        x+=lastGlyph.getKerning(ch) * scaleX;
        lastGlyph=g;
        addGlyph(lastGlyph,x + g.xoffset * scaleX,y + g.yoffset * scaleY,g.width * scaleX,g.height * scaleY);
        x+=g.xadvance * scaleX;
      }
    }
  }
  return x - startX;
}

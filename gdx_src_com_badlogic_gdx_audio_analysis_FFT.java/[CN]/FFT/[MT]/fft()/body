{
  for (int halfSize=1; halfSize < real.length; halfSize*=2) {
    float phaseShiftStepR=cos(halfSize);
    float phaseShiftStepI=sin(halfSize);
    float currentPhaseShiftR=1.0f;
    float currentPhaseShiftI=0.0f;
    for (int fftStep=0; fftStep < halfSize; fftStep++) {
      for (int i=fftStep; i < real.length; i+=2 * halfSize) {
        int off=i + halfSize;
        float tr=(currentPhaseShiftR * real[off]) - (currentPhaseShiftI * imag[off]);
        float ti=(currentPhaseShiftR * imag[off]) + (currentPhaseShiftI * real[off]);
        real[off]=real[i] - tr;
        imag[off]=imag[i] - ti;
        real[i]+=tr;
        imag[i]+=ti;
      }
      float tmpR=currentPhaseShiftR;
      currentPhaseShiftR=(tmpR * phaseShiftStepR) - (currentPhaseShiftI * phaseShiftStepI);
      currentPhaseShiftI=(tmpR * phaseShiftStepI) + (currentPhaseShiftI * phaseShiftStepR);
    }
  }
}

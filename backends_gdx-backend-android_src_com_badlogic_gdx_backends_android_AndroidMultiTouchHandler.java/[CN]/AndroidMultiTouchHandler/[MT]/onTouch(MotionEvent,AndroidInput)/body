{
  final int action=event.getAction() & MotionEvent.ACTION_MASK;
  int pointerIndex=(event.getAction() & MotionEvent.ACTION_POINTER_ID_MASK) >> MotionEvent.ACTION_POINTER_ID_SHIFT;
  int pointerId=event.getPointerId(pointerIndex);
  int x=0, y=0;
  int realPointerIndex=0;
  long timeStamp=System.nanoTime();
synchronized (input) {
switch (action) {
case MotionEvent.ACTION_DOWN:
case MotionEvent.ACTION_POINTER_DOWN:
      realPointerIndex=input.getFreePointerIndex();
    if (realPointerIndex > input.realId.length || realPointerIndex > input.touchX.length || realPointerIndex > input.touchY.length || realPointerIndex > input.deltaX.length || realPointerIndex > input.deltaY.length || realPointerIndex > input.touched.length)     break;
  input.realId[realPointerIndex]=pointerId;
x=(int)event.getX(pointerIndex);
y=(int)event.getY(pointerIndex);
postTouchEvent(input,TouchEvent.TOUCH_DOWN,x,y,realPointerIndex,timeStamp);
input.touchX[realPointerIndex]=x;
input.touchY[realPointerIndex]=y;
input.deltaX[realPointerIndex]=0;
input.deltaY[realPointerIndex]=0;
input.touched[realPointerIndex]=true;
break;
case MotionEvent.ACTION_UP:
case MotionEvent.ACTION_POINTER_UP:
case MotionEvent.ACTION_OUTSIDE:
case MotionEvent.ACTION_CANCEL:
realPointerIndex=input.lookUpPointerIndex(pointerId);
if (realPointerIndex == -1) break;
if (realPointerIndex > input.realId.length || realPointerIndex > input.touchX.length || realPointerIndex > input.touchY.length || realPointerIndex > input.deltaX.length || realPointerIndex > input.deltaY.length || realPointerIndex > input.touched.length) break;
input.realId[realPointerIndex]=-1;
x=(int)event.getX(pointerIndex);
y=(int)event.getY(pointerIndex);
postTouchEvent(input,TouchEvent.TOUCH_UP,x,y,realPointerIndex,timeStamp);
input.touchX[realPointerIndex]=x;
input.touchY[realPointerIndex]=y;
input.deltaX[realPointerIndex]=0;
input.deltaY[realPointerIndex]=0;
input.touched[realPointerIndex]=false;
break;
case MotionEvent.ACTION_MOVE:
int pointerCount=event.getPointerCount();
for (int i=0; i < pointerCount; i++) {
pointerIndex=i;
pointerId=event.getPointerId(pointerIndex);
x=(int)event.getX(pointerIndex);
y=(int)event.getY(pointerIndex);
realPointerIndex=input.lookUpPointerIndex(pointerId);
if (realPointerIndex == -1) continue;
if (realPointerIndex > input.touchX.length || realPointerIndex > input.touchY.length || realPointerIndex > input.deltaX.length || realPointerIndex > input.deltaY.length) break;
postTouchEvent(input,TouchEvent.TOUCH_DRAGGED,x,y,realPointerIndex,timeStamp);
input.deltaX[realPointerIndex]=x - input.touchX[realPointerIndex];
input.deltaY[realPointerIndex]=y - input.touchY[realPointerIndex];
input.touchX[realPointerIndex]=x;
input.touchY[realPointerIndex]=y;
}
break;
}
}
Gdx.app.getGraphics().requestRendering();
}
